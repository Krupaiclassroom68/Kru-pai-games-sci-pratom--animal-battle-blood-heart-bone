<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Kru Pai Classroom ‚Äî Animal Battle (100 ‡∏Ç‡πâ‡∏≠‡πÄ‡∏ï‡πá‡∏°)</title>
<style>
:root{
  --brand:#ff9f4a;   /* ‡∏™‡πâ‡∏°‡∏û‡∏µ‡∏ä‡∏™‡∏î‡πÉ‡∏™ */
  --brand-2:#4db6ff; /* ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô‡∏™‡∏î‡πÉ‡∏™ */
  --ok:#34a853;
  --bad:#ea4335;
  --text:#263238;
  --card:#fffdfb;
  --card-border:#ffe0b2;
  --chip:#fff3e0;
  --chip-text:#8d6e63;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:var(--text);
  background: linear-gradient(180deg, #d9f1ff 0%, #fff0e0 100%);
  background-attachment: fixed;
}
.container{max-width:980px;margin:0 auto;padding:20px 20px 44px}
.card{
  background:var(--card);
  border:2px solid var(--card-border);
  border-radius:24px;
  padding:20px;
  box-shadow:0 10px 28px rgba(255,159,74,.22), 0 4px 12px rgba(0,0,0,.04);
}
.title{font-size:30px;font-weight:900;margin:0 0 6px;letter-spacing:.3px}
.sub{color:#5d6b73;margin:0 0 16px}
.pill{
  display:inline-flex;gap:8px;align-items:center;
  padding:8px 14px;border:2px solid #ffd8a8;border-radius:999px;
  background:var(--chip);font-weight:800;color:var(--chip-text)
}
.pill::before{content:"‚≠ê";}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.btn{
  display:inline-flex;align-items:center;justify-content:center;
  padding:12px 18px;border-radius:14px;border:2px solid #ffd8a8;
  background:#fff7ef;font-weight:900;cursor:pointer;transition:.18s;box-shadow:0 3px 0 rgba(0,0,0,.05)
}
.btn:hover{transform:translateY(-2px)}
.btn.primary{
  background:var(--brand);
  color:#fff;border-color:var(--brand);
  box-shadow:0 6px 0 #ff8a26;
}
.btn.primary:hover{background:#ffa94d;transform:translateY(-2px)}
.btn.lock{opacity:.5;filter:grayscale(.1);cursor:not-allowed}
.input,.select{
  padding:12px 14px;border-radius:14px;border:2px solid #ffd8a8;min-width:220px;background:#fff;
  font-weight:700
}
.hint{
  background:linear-gradient(90deg, #fff7ef, #e6f6ff);
  border:2px dashed #ffc78d;padding:14px;border-radius:16px
}
.note{color:#6c7a80;font-size:12px}

/* quiz */
.q-head{display:flex;align-items:center;justify-content:space-between;gap:12px}
.progress{font-weight:900}
.timer{
  min-width:88px;text-align:right;font-variant-numeric:tabular-nums;
  padding:6px 10px;border-radius:999px;background:#e3f2ff;border:2px solid #b3e0ff;font-weight:900;
}
.qword{font-size:32px;font-weight:900;text-align:center;margin:18px 0}
.choices{display:grid;grid-template-columns:1fr;gap:12px}
.choice{
  padding:16px;border:3px solid #ffd8a8;border-radius:16px;background:#ffffff;
  font-size:22px;font-weight:900;cursor:pointer;transition:.18s
}
.choice:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.05)}
.choice.correct{border-color:var(--ok);background:#e8fff3}
.choice.wrong{border-color:var(--bad);background:#fff1f1}
.locked{pointer-events:none;opacity:.92}
@media (min-width:560px){ .choices{grid-template-columns:1fr 1fr} }

/* results & charts */
.badge{
  padding:8px 12px;border-radius:999px;border:2px solid #b3e0ff;background:#e3f2ff;font-weight:900
}
.grade{
  display:inline-flex;align-items:center;justify-content:center;
  width:64px;height:64px;border-radius:16px;font-size:24px;font-weight:900;margin-left:8px
}
.grade.A{background:#e8fff3;color:var(--ok)} .grade.B{background:#f4ffe8;color:#3b7c0a}
.grade.C{background:#fff7e8;color:#a46200} .grade.D{background:#fff1f1;color:var(--bad)}
.chart{margin-top:12px}
.series-grid{display:grid;grid-template-columns:1fr;gap:14px}
@media(min-width:720px){ .series-grid{grid-template-columns:1fr 1fr} }
.series-box{padding:16px;border:2px solid #b3e0ff;border-radius:16px;background:#f7fbff}
.bar{height:12px;border-radius:8px;background:linear-gradient(90deg,var(--brand),var(--brand-2))}

/* subtle confetti canvas layering */
.confetti-canvas{
  position:fixed;inset:0;pointer-events:none;z-index:9999
}
</style>
<noscript>
  <div style="background:#fff1f1;color:#b20b0b;padding:12px;text-align:center;font-weight:800">
    ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î JavaScript ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå (‡πÄ‡∏ä‡πà‡∏ô Chrome/Edge/Safari)
  </div>
</noscript>
</head>
<body>
<canvas id="confetti" class="confetti-canvas"></canvas>

<div class="container">

  <!-- HOME -->
  <section id="home" class="card">
    <div class="pill">Kru Pai Classroom</div>
    <h1 class="title">Animal Battle ‚Äî 100 ‡∏Ç‡πâ‡∏≠ (‡∏ä‡∏∏‡∏î1:40 | ‡∏ä‡∏∏‡∏î2:30 | ‡∏ä‡∏∏‡∏î3:30)</h1>
    <p class="sub">‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô ‚Üí ‡πÄ‡∏Å‡∏° (10 ‡∏ß‡∏¥/‡∏Ç‡πâ‡∏≠) ‚Üí ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• + ‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° ‚Äî ‡∏ú‡πà‡∏≤‡∏ô ‚â•80% ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ)</p>

    <div class="row">
      <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô:</label>
      <input id="playerName" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡πâ‡∏≠‡∏á‡πÄ‡∏°‡∏¢‡πå / Nunu"/>
      <button class="btn" onclick="saveName()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠</button>
      <span id="hello" class="note"></span>
    </div>

    <div style="height:10px"></div>
    <div class="row">
      <button id="b1" class="btn primary" onclick="goReview('set1')">‡πÄ‡∏•‡πà‡∏ô‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà 1 üéØ</button>
      <button id="b2" class="btn lock" onclick="locked(2)">‡πÄ‡∏•‡πà‡∏ô‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà 2</button>
      <button id="b3" class="btn lock" onclick="locked(3)">‡πÄ‡∏•‡πà‡∏ô‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà 3</button>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" onclick="openSeries()">‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏ã‡∏µ‡∏£‡∏µ‡∏™‡πå üí´</button>
      <button class="btn" onclick="resetThisSession()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ)</button>
    </div>
    <div class="note" style="margin-top:8px">* ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</div>
  </section>

  <!-- REVIEW -->
  <section id="review" class="card" style="display:none">
    <div class="pill">‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏™‡∏±‡πâ‡∏ô ‡πÜ</div>
    <h1 class="title" id="revTitle">Animal Battle ‚Äî ‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà 1</h1>
    <div class="hint" id="revHint"></div>

    <div class="row" style="margin-top:10px">
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠:</label>
      <select id="qCount" class="select">
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="30">30</option>
        <option value="40">40</option>
      </select>
      <span class="note">* ‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ/‡∏Ç‡πâ‡∏≠</span>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn primary" onclick="startGame()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° ‚ûú</button>
      <button class="btn" onclick="backHome()">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
    </div>
  </section>

  <!-- QUIZ -->
  <section id="quiz" class="card" style="display:none">
    <div class="q-head">
      <div class="progress">‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà <span id="qIndex">1</span>/<span id="qTotal">10</span></div>
      <div class="timer"><span id="timer">10</span>s</div>
    </div>
    <div class="qword" id="qWord">word</div>
    <div class="choices" id="choices"></div>
  </section>

  <!-- RESULTS -->
  <section id="results" class="card" style="display:none">
    <h2 class="title">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h2>
    <p class="sub" id="sum"></p>
    <div class="row">
      <span class="badge" id="passBadge"></span>
      <span id="gradeBox" class="grade">A</span>
    </div>
    <div class="chart" id="attemptChart"></div>
    <div class="row" style="margin-top:12px">
      <button class="btn" onclick="startGame()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ã‡πâ‡∏≥</button>
      <button class="btn" onclick="backHome()">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
      <button class="btn primary" id="nextBtn" style="display:none">‡πÑ‡∏õ‡∏ä‡∏∏‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ûú</button>
    </div>
  </section>

  <!-- SERIES SUMMARY -->
  <section id="series" class="card" style="display:none">
    <div class="pill">Series Summary</div>
    <h1 class="title">‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏ã‡∏µ‡∏£‡∏µ‡∏™‡πå Animal Battle</h1>
    <p class="sub" id="seriesNote"></p>

    <div class="series-grid" style="margin-top:6px">
      <div class="series-box">
        <b>‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà 1 ‚Äî ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</b>
        <div id="chart1" class="chart"></div>
        <div id="score1"></div>
      </div>
      <div class="series-box">
        <b>‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà 2 ‚Äî ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</b>
        <div id="chart2" class="chart"></div>
        <div id="score2"></div>
      </div>
      <div class="series-box">
        <b>‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà 3 ‚Äî ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</b>
        <div id="chart3" class="chart"></div>
        <div id="score3"></div>
      </div>
      <div class="series-box">
        <b>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏∏‡∏î</b>
        <div id="bestBars" class="chart"></div>
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <button class="btn" onclick="backHome()">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
    </div>
  </section>

</div>

<script>
/* ============ Storage helper ============ */
let hasLS = true;
try { localStorage.setItem("__kpc_test","1"); localStorage.removeItem("__kpc_test"); }
catch(e){ hasLS = false; }
const mem = {};
function getArr(key){
  if(hasLS){
    try{ const s = localStorage.getItem(key); return s? JSON.parse(s): []; }catch(e){}
  }
  return mem[key] ? [...mem[key]] : [];
}
function setArr(key, arr){
  if(hasLS){
    try{ localStorage.setItem(key, JSON.stringify(arr)); return; }catch(e){}
  }
  mem[key] = [...arr];
}
function pushArr(key, val){
  const arr = getArr(key); arr.push(val); setArr(key, arr);
}

/* ============ Data (expanded to 100 items total) ============ */
// ‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà 1: ‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏™‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á / ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏™‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á (40 ‡∏Ç‡πâ‡∏≠)
const ANIMALS_VERTE = [
  {name:"‡πÅ‡∏°‡∏ß", v:true},{name:"‡∏™‡∏∏‡∏ô‡∏±‡∏Ç", v:true},{name:"‡∏ô‡∏Å", v:true},{name:"‡∏õ‡∏•‡∏≤", v:true},{name:"‡∏á‡∏π", v:true},
  {name:"‡∏Å‡∏ö", v:true},{name:"‡∏ä‡πâ‡∏≤‡∏á", v:true},{name:"‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå", v:true},{name:"‡∏ß‡∏±‡∏ß", v:true},{name:"‡∏°‡πâ‡∏≤", v:true},
  {name:"‡∏´‡∏°‡∏π", v:true},{name:"‡∏™‡∏¥‡∏á‡πÇ‡∏ï", v:true},{name:"‡∏•‡∏¥‡∏á", v:true},{name:"‡∏õ‡∏•‡∏≤‡∏ß‡∏≤‡∏¨", v:true},{name:"‡∏õ‡∏•‡∏≤‡πÇ‡∏•‡∏°‡∏≤", v:true},
  {name:"‡πÄ‡∏û‡∏ô‡∏Å‡∏ß‡∏¥‡∏ô", v:true},{name:"‡∏à‡∏£‡∏∞‡πÄ‡∏Ç‡πâ", v:true},{name:"‡πÄ‡∏ï‡πà‡∏≤", v:true},{name:"‡∏â‡∏•‡∏≤‡∏°", v:true},{name:"‡∏Ñ‡πâ‡∏≤‡∏á‡∏Ñ‡∏≤‡∏ß", v:true},
  {name:"‡πÄ‡∏™‡∏∑‡∏≠‡πÇ‡∏Ñ‡∏£‡πà‡∏á", v:true},{name:"‡πÅ‡∏û‡∏ô‡∏î‡πâ‡∏≤", v:true},{name:"‡∏Å‡∏ß‡∏≤‡∏á", v:true},{name:"‡πÅ‡∏Å‡∏∞", v:true},{name:"‡πÅ‡∏û‡∏∞", v:true},
  {name:"‡∏Æ‡∏¥‡∏õ‡πÇ‡∏õ", v:true},{name:"‡πÅ‡∏£‡∏î", v:true},{name:"‡∏ô‡∏Å‡πÄ‡∏Ñ‡πâ‡∏≤‡πÅ‡∏°‡∏ß", v:true},{name:"‡∏ô‡∏Å‡∏Å‡∏£‡∏∞‡∏à‡∏≠‡∏Å", v:true},{name:"‡πÑ‡∏Å‡πà‡∏á‡∏ß‡∏á", v:true},
  {name:"‡∏ú‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠", v:false},{name:"‡∏°‡∏î", v:false},{name:"‡πÅ‡∏°‡∏á‡∏°‡∏∏‡∏°", v:false},{name:"‡∏Å‡∏∏‡πâ‡∏á", v:false},{name:"‡∏õ‡∏π", v:false},
  {name:"‡∏õ‡∏•‡∏≤‡∏´‡∏°‡∏∂‡∏Å", v:false},{name:"‡πÑ‡∏™‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", v:false},{name:"‡πÅ‡∏°‡∏á‡∏Å‡∏∞‡∏û‡∏£‡∏∏‡∏ô", v:false},{name:"‡∏ï‡∏∞‡∏Ç‡∏≤‡∏ö", v:false},{name:"‡∏´‡∏≠‡∏¢‡∏ô‡∏≤‡∏á‡∏£‡∏°", v:false}
];

// ‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏∏‡πà‡∏ô / ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÄ‡∏¢‡πá‡∏ô (30 ‡∏Ç‡πâ‡∏≠)
const ANIMALS_BLOOD = [
  // ‡∏≠‡∏∏‡πà‡∏ô (‡∏ô‡∏Å + ‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏°)
  {name:"‡πÅ‡∏°‡∏ß", warm:true},{name:"‡∏™‡∏∏‡∏ô‡∏±‡∏Ç", warm:true},{name:"‡∏Ñ‡∏ô", warm:true},{name:"‡∏Ñ‡πâ‡∏≤‡∏á‡∏Ñ‡∏≤‡∏ß", warm:true},{name:"‡∏õ‡∏•‡∏≤‡∏ß‡∏≤‡∏¨", warm:true},
  {name:"‡πÇ‡∏•‡∏°‡∏≤", warm:true},{name:"‡∏ä‡πâ‡∏≤‡∏á", warm:true},{name:"‡∏ß‡∏±‡∏ß", warm:true},{name:"‡∏°‡πâ‡∏≤", warm:true},{name:"‡πÅ‡∏û‡∏ô‡∏î‡πâ‡∏≤", warm:true},
  {name:"‡∏•‡∏¥‡∏á", warm:true},{name:"‡∏™‡∏¥‡∏á‡πÇ‡∏ï", warm:true},{name:"‡∏ô‡∏Å‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ", warm:true},{name:"‡πÑ‡∏Å‡πà", warm:true},{name:"‡πÄ‡∏û‡∏ô‡∏Å‡∏ß‡∏¥‡∏ô", warm:true},
  // ‡πÄ‡∏¢‡πá‡∏ô (‡∏õ‡∏•‡∏≤/‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ö‡∏Å‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ô‡πâ‡∏≥/‡πÄ‡∏•‡∏∑‡πâ‡∏≠‡∏¢‡∏Ñ‡∏•‡∏≤‡∏ô/‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏™‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á)
  {name:"‡∏á‡∏π", warm:false},{name:"‡∏à‡∏£‡∏∞‡πÄ‡∏Ç‡πâ", warm:false},{name:"‡∏Å‡∏ö", warm:false},{name:"‡πÄ‡∏ï‡πà‡∏≤", warm:false},{name:"‡∏â‡∏•‡∏≤‡∏°", warm:false},
  {name:"‡∏õ‡∏•‡∏≤‡πÅ‡∏ã‡∏•‡∏°‡∏≠‡∏ô", warm:false},{name:"‡∏õ‡∏•‡∏≤‡∏ó‡∏≠‡∏á", warm:false},{name:"‡∏õ‡∏•‡∏≤‡∏Å‡∏£‡∏∞‡∏û‡∏á", warm:false},{name:"‡∏õ‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô", warm:false},{name:"‡∏õ‡∏•‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏ö‡∏ô", warm:false},
  {name:"‡∏Å‡∏∏‡πâ‡∏á", warm:false},{name:"‡∏õ‡∏π", warm:false},{name:"‡∏õ‡∏•‡∏≤‡∏´‡∏°‡∏∂‡∏Å", warm:false},{name:"‡πÅ‡∏°‡∏á‡∏°‡∏∏‡∏°", warm:false},{name:"‡πÑ‡∏™‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", warm:false}
];

// ‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà 3: ‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏±‡∏ß‡πÉ‡∏à (2/3/4 ‡∏´‡πâ‡∏≠‡∏á) (30 ‡∏Ç‡πâ‡∏≠)
const ANIMALS_HEART = [
  // 2 ‡∏´‡πâ‡∏≠‡∏á (‡∏õ‡∏•‡∏≤)
  {name:"‡∏â‡∏•‡∏≤‡∏°", chambers:2},{name:"‡∏õ‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô", chambers:2},{name:"‡∏õ‡∏•‡∏≤‡∏ó‡∏π", chambers:2},{name:"‡∏Å‡∏£‡∏∞‡πÄ‡∏ö‡∏ô", chambers:2},{name:"‡∏õ‡∏•‡∏≤‡∏ó‡∏≠‡∏á", chambers:2},
  {name:"‡∏õ‡∏•‡∏≤‡πÅ‡∏ã‡∏•‡∏°‡∏≠‡∏ô", chambers:2},{name:"‡∏õ‡∏•‡∏≤‡∏Å‡∏£‡∏∞‡∏û‡∏á", chambers:2},{name:"‡∏õ‡∏•‡∏≤‡∏Å‡∏∏‡πÄ‡∏•‡∏≤", chambers:2},{name:"‡∏õ‡∏•‡∏≤‡∏î‡∏∏‡∏Å", chambers:2},{name:"‡∏õ‡∏•‡∏≤‡∏ä‡πà‡∏≠‡∏ô", chambers:2},
  // 3 ‡∏´‡πâ‡∏≠‡∏á (‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà ‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ö‡∏Å‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ô‡πâ‡∏≥ + ‡πÄ‡∏•‡∏∑‡πâ‡∏≠‡∏¢‡∏Ñ‡∏•‡∏≤‡∏ô)
  {name:"‡∏Å‡∏ö", chambers:3},{name:"‡∏ã‡∏≤‡∏•‡∏≤‡πÅ‡∏°‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå", chambers:3},{name:"‡∏Ñ‡∏≤‡∏á‡∏Ñ‡∏Å", chambers:3},{name:"‡πÄ‡∏ï‡πà‡∏≤", chambers:3},{name:"‡∏ï‡∏∞‡∏û‡∏≤‡∏ö", chambers:3},
  {name:"‡∏Å‡∏¥‡πâ‡∏á‡∏Å‡πà‡∏≤", chambers:3},{name:"‡∏à‡∏¥‡πâ‡∏á‡∏à‡∏Å", chambers:3},{name:"‡∏á‡∏π", chambers:3},{name:"‡∏≠‡∏µ‡∏Å‡∏±‡∏ß‡∏ô‡πà‡∏≤", chambers:3},{name:"‡∏Å‡∏¥‡πâ‡∏á‡∏Å‡πà‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏°‡πÄ‡∏•‡∏µ‡∏¢‡∏ô", chambers:3},
  // 4 ‡∏´‡πâ‡∏≠‡∏á (‡∏ô‡∏Å + ‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏° + ‡∏à‡∏£‡∏∞‡πÄ‡∏Ç‡πâ)
  {name:"‡∏à‡∏£‡∏∞‡πÄ‡∏Ç‡πâ", chambers:4},{name:"‡πÄ‡∏û‡∏ô‡∏Å‡∏ß‡∏¥‡∏ô", chambers:4},{name:"‡πÑ‡∏Å‡πà", chambers:4},{name:"‡∏ô‡∏Å‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ", chambers:4},{name:"‡∏ô‡∏Å‡∏Æ‡∏π‡∏Å", chambers:4},
  {name:"‡∏Ñ‡∏ô", chambers:4},{name:"‡πÅ‡∏°‡∏ß", chambers:4},{name:"‡∏™‡∏∏‡∏ô‡∏±‡∏Ç", chambers:4},{name:"‡∏õ‡∏•‡∏≤‡∏ß‡∏≤‡∏¨", chambers:4},{name:"‡∏ä‡πâ‡∏≤‡∏á", chambers:4}
];

const PASS = 80;
const NAME_KEY = "kpc_player_name";
const SCORE_KEYS = { set1:"kpc_scores_animal_set1", set2:"kpc_scores_animal_set2", set3:"kpc_scores_animal_set3" };

/* ============ State ============ */
let unlocked2=false, unlocked3=false;
let currentSetId="set1";
let order=[], idx=0, score=0, timer=null, timeLeft=10;
let currentQuestions=[];

/* ============ Init ============ */
(function init(){
  const n = getName();
  document.getElementById('playerName').value = n;
  document.getElementById('hello').textContent = n ? `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${n} üëã` : "";
})();

function saveName(){
  const v = document.getElementById('playerName').value.trim();
  if(hasLS){ try{ localStorage.setItem(NAME_KEY, v); }catch(e){} }
  else { mem[NAME_KEY] = v; }
  document.getElementById('hello').textContent = v ? `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${v} üëã` : "";
  alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
}
function getName(){
  if(hasLS){ try{ return localStorage.getItem(NAME_KEY) || ""; }catch(e){} }
  return mem[NAME_KEY] || "";
}

/* ============ Navigation ============ */
function locked(n){ alert("‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà "+n+" ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡πà‡∏≤‡∏ô‡∏ä‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‚â•80% ‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ"); }
function goReview(id){
  if(id==="set2" && !unlocked2) return locked(2);
  if(id==="set3" && !unlocked3) return locked(3);
  currentSetId = id;
  show('home', false); show('results', false); show('quiz', false);
  show('review', true);
  const t = id==="set1" ? "‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà 1 ‚Äî ‡∏°‡∏µ‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏™‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á / ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏™‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á"
        : id==="set2" ? "‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà 2 ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏∏‡πà‡∏ô / ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÄ‡∏¢‡πá‡∏ô"
        : "‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà 3 ‚Äî ‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏±‡∏ß‡πÉ‡∏à (2/3/4)";
  document.getElementById('revTitle').textContent = "Animal Battle ‚Äî " + t;
  const hint = document.getElementById('revHint');
  if(id==="set1"){
    hint.innerHTML = "‚Ä¢ <b>‡∏°‡∏µ‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏™‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á</b>: ‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏°‡∏µ‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏Å‡∏ô‡∏´‡∏•‡∏±‡∏á ‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏°‡∏ß ‡∏ô‡∏Å ‡∏õ‡∏•‡∏≤ ‡∏á‡∏π ‡∏Å‡∏ö<br>‚Ä¢ <b>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏™‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á</b>: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏Å‡∏ô‡∏™‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á ‡πÄ‡∏ä‡πà‡∏ô ‡∏ú‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠ ‡∏Å‡∏∏‡πâ‡∏á ‡∏õ‡∏π ‡∏õ‡∏•‡∏≤‡∏´‡∏°‡∏∂‡∏Å ‡πÑ‡∏™‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô";
    setQCountDefault(40);
  }else if(id==="set2"){
    hint.innerHTML = "‚Ä¢ <b>‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏∏‡πà‡∏ô</b>: ‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏° ‡πÅ‡∏•‡∏∞‡∏ô‡∏Å ‚Äî ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏Ñ‡∏á‡∏ó‡∏µ‡πà<br>‚Ä¢ <b>‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÄ‡∏¢‡πá‡∏ô</b>: ‡∏õ‡∏•‡∏≤ ‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ö‡∏Å‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ô‡πâ‡∏≥ ‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏∑‡πâ‡∏≠‡∏¢‡∏Ñ‡∏•‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏™‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á ‚Äî ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÅ‡∏õ‡∏£‡∏ú‡∏±‡∏ô";
    setQCountDefault(30);
  }else{
    hint.innerHTML = "‚Ä¢ <b>2 ‡∏´‡πâ‡∏≠‡∏á</b>: ‡∏õ‡∏•‡∏≤<br>‚Ä¢ <b>3 ‡∏´‡πâ‡∏≠‡∏á</b>: ‡∏Å‡∏ö ‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ö‡∏Å‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ô‡πâ‡∏≥ ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏∑‡πâ‡∏≠‡∏¢‡∏Ñ‡∏•‡∏≤‡∏ô<br>‚Ä¢ <b>4 ‡∏´‡πâ‡∏≠‡∏á</b>: ‡∏ô‡∏Å ‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏° (‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏à‡∏£‡∏∞‡πÄ‡∏Ç‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏¥‡πÄ‡∏®‡∏©)";
    setQCountDefault(30);
  }
}
function setQCountDefault(n){
  const el = document.getElementById('qCount');
  if(!el) return;
  [...el.options].forEach(o=> o.selected = (parseInt(o.value,10)===n));
}
function backHome(){ stopTimer(); show('review',false); show('quiz',false); show('results',false); show('series',false); show('home',true); }
function show(id,on){ document.getElementById(id).style.display = on?'block':'none'; }

function openSeries(){
  show('home',false); show('series',true);
  const n = getName() || "‡∏ô‡∏±‡∏Å‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏™‡∏±‡∏ï‡∏ß‡πå";
  document.getElementById('seriesNote').textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${n} ‚Äî ‡∏î‡∏π‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏∏‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà`;
  const a1 = getArr(SCORE_KEYS.set1).slice(-10);
  const a2 = getArr(SCORE_KEYS.set2).slice(-10);
  const a3 = getArr(SCORE_KEYS.set3).slice(-10);
  renderChart("#chart1", a1);
  renderChart("#chart2", a2);
  renderChart("#chart3", a3);
  setText('score1', scoreBlock(SCORE_KEYS.set1));
  setText('score2', scoreBlock(SCORE_KEYS.set2));
  setText('score3', scoreBlock(SCORE_KEYS.set3));
  renderBestBars();
}

function resetThisSession(){
  unlocked2=false; unlocked3=false;
  document.getElementById('b2').className = "btn lock"; document.getElementById('b2').onclick = ()=>locked(2);
  document.getElementById('b3').className = "btn lock"; document.getElementById('b3').onclick = ()=>locked(3);
  alert("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
}

/* ============ Quiz Flow ============ */
function qCount(){
  const el = document.getElementById('qCount');
  return el ? Math.max(1, parseInt(el.value||"10",10)) : 10;
}

function startGame(){
  show('review',false); show('quiz',true); show('results',false);
  const data = (currentSetId==="set1") ? shuffle([...ANIMALS_VERTE]).slice(0, qCount())
             : (currentSetId==="set2") ? shuffle([...ANIMALS_BLOOD]).slice(0, qCount())
             : shuffle([...ANIMALS_HEART]).slice(0, qCount());
  currentQuestions = data;
  order = currentQuestions;
  idx=0; score=0;
  setText('qTotal', currentQuestions.length);
  renderQ();
}

function renderQ(){
  if(idx>=order.length){ return finish(); }
  const q = order[idx];
  setText('qIndex', idx+1);
  let prompt = "";
  let opts = [];
  if(currentSetId==="set1"){
    prompt = `‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ä‡∏ô‡∏¥‡∏î ‚Äú${q.name}‚Äù ‡∏à‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡πÉ‡∏î?`;
    opts = [
      {label:"‡∏°‡∏µ‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏™‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á", ok:q.v===true},
      {label:"‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏™‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á", ok:q.v===false},
    ];
  }else if(currentSetId==="set2"){
    prompt = `‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ä‡∏ô‡∏¥‡∏î ‚Äú${q.name}‚Äù ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÅ‡∏ö‡∏ö‡πÉ‡∏î?`;
    opts = [
      {label:"‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏∏‡πà‡∏ô", ok:q.warm===true},
      {label:"‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÄ‡∏¢‡πá‡∏ô", ok:q.warm===false},
    ];
  }else{
    prompt = `‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ä‡∏ô‡∏¥‡∏î ‚Äú${q.name}‚Äù ‡∏°‡∏µ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏Å‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á?`;
    opts = [
      {label:"2 ‡∏´‡πâ‡∏≠‡∏á", ok:q.chambers===2},
      {label:"3 ‡∏´‡πâ‡∏≠‡∏á", ok:q.chambers===3},
      {label:"4 ‡∏´‡πâ‡∏≠‡∏á", ok:q.chambers===4},
    ];
  }

  setText('qWord', prompt);
  const box = document.getElementById('choices');
  box.classList.remove('locked'); box.innerHTML='';
  shuffle(opts).forEach(o=>{
    const btn = document.createElement('button');
    btn.className='choice'; btn.textContent=o.label;
    btn.onclick = ()=> pick(o.ok, btn);
    box.appendChild(btn);
  });
  startTimer();
}

function startTimer(){
  stopTimer(); timeLeft=10; setText('timer', timeLeft);
  timer = setInterval(()=>{
    timeLeft--; setText('timer', timeLeft);
    if(timeLeft<=0){ stopTimer(); showCorrect(); setTimeout(next, 600); }
  }, 1000);
}
function stopTimer(){ if(timer){ clearInterval(timer); timer=null; } }
function setText(id, v){ const el=document.getElementById(id); if(el) el.textContent=v; }

function showCorrect(){
  const q = order[idx];
  document.querySelectorAll('.choice').forEach(el=>{
    if(currentSetId==="set1"){
      const correct = q.v ? "‡∏°‡∏µ‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏™‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á" : "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏™‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á";
      if(el.textContent===correct){ el.classList.add('correct'); }
    }else if(currentSetId==="set2"){
      const correct = q.warm ? "‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏∏‡πà‡∏ô" : "‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÄ‡∏¢‡πá‡∏ô";
      if(el.textContent===correct){ el.classList.add('correct'); }
    }else{
      const correct = (q.chambers===2?"2 ‡∏´‡πâ‡∏≠‡∏á":q.chambers===3?"3 ‡∏´‡πâ‡∏≠‡∏á":"4 ‡∏´‡πâ‡∏≠‡∏á");
      if(el.textContent===correct){ el.classList.add('correct'); }
    }
  });
}
function pick(ok, el){
  stopTimer();
  if(ok){ score++; el.classList.add('correct'); }
  else{ el.classList.add('wrong'); showCorrect(); }
  document.getElementById('choices').classList.add('locked');
  setTimeout(next, 450);
}
function next(){ idx++; renderQ(); }

/* ============ Results ============ */
function finish(){
  show('quiz',false); show('results',true);
  const total = currentQuestions.length;
  const pct = Math.round((score/total)*100);
  const grade = pct>=90?'A':pct>=80?'B':pct>=70?'C':'D';
  setText('sum', `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${score}/${total} (${pct}%)`);
  const g = document.getElementById('gradeBox'); g.className='grade '+grade; g.textContent=grade;
  const passB = document.getElementById('passBadge');
  const nextBtn = document.getElementById('nextBtn');
  if(pct>=PASS){
    passB.textContent = `‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå ${PASS}% ‚úÖ`;
    nextBtn.style.display='inline-flex';
    nextBtn.onclick = ()=>{
      if(currentSetId==='set1'){ unlocked2=true; goReview('set2'); updateHomeButtons(); }
      else if(currentSetId==='set2'){ unlocked3=true; goReview('set3'); updateHomeButtons(); }
      else{ openSeries(); }
    };
    confettiBurst();
  }else{
    passB.textContent = `‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á ${PASS}% ‚ùå`;
    nextBtn.style.display='none';
  }
  const key = SCORE_KEYS[currentSetId];
  pushArr(key, { ts: Date.now(), pct });
  renderChart("#attemptChart", getArr(key).slice(-10));
}

function updateHomeButtons(){
  const b2 = document.getElementById('b2'), b3 = document.getElementById('b3');
  if(unlocked2){ b2.className="btn primary"; b2.onclick = ()=> goReview('set2'); }
  if(unlocked3){ b3.className="btn primary"; b3.onclick = ()=> goReview('set3'); }
}

/* ============ Series Summary helpers ============ */
function scoreBlock(key){
  const arr = getArr(key);
  const last = arr.length ? arr[arr.length-1].pct : 0;
  const best = arr.reduce((m,d)=> Math.max(m, d.pct), 0);
  return `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <b>${Math.round(last)}%</b> ‚Ä¢ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: <b>${Math.round(best)}%</b>`;
}
function renderBestBars(){
  const b1 = getArr(SCORE_KEYS.set1).reduce((m,d)=>Math.max(m,d.pct),0);
  const b2 = getArr(SCORE_KEYS.set2).reduce((m,d)=>Math.max(m,d.pct),0);
  const b3 = getArr(SCORE_KEYS.set3).reduce((m,d)=>Math.max(m,d.pct),0);
  const el = document.getElementById('bestBars');
  el.innerHTML = bar("‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà 1", b1) + bar("‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà 2", b2) + bar("‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà 3", b3);
  function bar(label, v){
    const pct = Math.round(v||0);
    return `<div style="margin:8px 0">
      <div class="row" style="justify-content:space-between"><div>${label}</div><div>${pct}%</div></div>
      <div style="background:#eaf4ff;border-radius:8px;overflow:hidden;border:2px solid #b3e0ff">
        <div class="bar" style="width:${pct}%;"></div>
      </div>
    </div>`;
  }
}

/* ============ Charts (inline SVG) ============ */
function renderChart(selector, attempts){
  const el = document.querySelector(selector); if(!el) return;
  const W = Math.min(620, window.innerWidth - 48), H = 200, pad = 28;
  const maxX = Math.max(1, attempts.length-1);
  const xStep = (W - pad*2) / Math.max(1, attempts.length-1 || 1);
  const yScale = (H - pad*2) / 100;
  const pts = attempts.map((d,i)=>({ x: pad + (maxX===0?0:i*xStep), y: pad + (100 - d.pct)*yScale, v: d.pct }));
  const axis = `
    <line x1="${pad}" y1="${pad}" x2="${pad}" y2="${H-pad}" stroke="#cfe8ff"/>
    <line x1="${pad}" y1="${H-pad}" x2="${W-pad}" y2="${H-pad}" stroke="#cfe8ff"/>
    ${[100,80,60,40,20,0].map(v=>{
      const y = pad + (100 - v)*yScale;
      return `<line x1="${pad}" y1="${y}" x2="${W-pad}" y2="${y}" stroke="#eaf4ff"/>
              <text x="${pad-8}" y="${y+4}" font-size="10" text-anchor="end" fill="#6c8db0">${v}%</text>`;
    }).join('')}
  `;
  const path = pts.map((p,i)=> (i?`L${p.x},${p.y}`:`M${p.x},${p.y}`)).join(' ');
  const dots = pts.map(p=>`<circle cx="${p.x}" cy="${p.y}" r="3" fill="#3e5b7a"><title>${Math.round(p.v)}%</title></circle>`).join('');
  el.innerHTML = `<svg width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">
    ${axis}
    <path d="${path}" fill="none" stroke="#3e5b7a" stroke-width="2.5"/>
    ${dots}
  </svg>`;
}

/* ============ Utils ============ */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

/* ============ Tiny Confetti ============ */
function confettiBurst(){
  const cvs = document.getElementById('confetti');
  const ctx = cvs.getContext('2d');
  const W = cvs.width = window.innerWidth;
  const H = cvs.height = window.innerHeight;
  const pieces = Array.from({length: 140}).map(()=> ({
    x: Math.random()*W,
    y: -20 - Math.random()*H*0.3,
    r: 3 + Math.random()*4,
    vy: 2 + Math.random()*3,
    vx: -1 + Math.random()*2,
    a: Math.random()*Math.PI,
    col: Math.random() < .5 ? '#ff9f4a' : '#4db6ff'
  }));
  let t = 0, stop = false;
  function draw(){
    if(stop) return;
    ctx.clearRect(0,0,W,H);
    pieces.forEach(p=>{
      p.x += p.vx;
      p.y += p.vy;
      p.a += 0.04;
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.a);
      ctx.fillStyle = p.col;
      ctx.fillRect(-p.r, -p.r, p.r*2, p.r*2);
      ctx.restore();
    });
    t++;
    if(t>180){ stop=true; ctx.clearRect(0,0,W,H); }
    else requestAnimationFrame(draw);
  }
  draw();
}
</script>
</body>
</html>
